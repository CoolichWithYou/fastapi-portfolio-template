# Category project

## Содержание

1. [Запуск](#1-запуск)
2. [Описание](#2-описание)
3. [Переменные среды](#3-переменные-среды)
4. [Эндпоинты](#4-эндпоинты)
5. [Диаграммы](#5-диаграммы)

## 1. Запуск

В корне проекта введите `make up`, - это запустит compose файл со всеми контейнерами.

Далее, в терминале введите  
`docker exec category_server alembic -c ./server/alembic.ini upgrade head`, - для применения миграций из папки version в контейнере.

Теперь можно переходить на `localhost:8000`, Готово!

## 2. Описание

Полноценный микросервис для добавления и отображения категорий.

Для вывода категорий (как на главной, так и на вложенных страницах) используется рекурсивный CTE-запрос в PostgreSQL.

Базовый запрос:
```postgresql
SELECT id,
       name,
       parent_id,
       0          AS level,
       ARRAY [id] AS path
FROM category
WHERE parent_id IS NULL
```

Рекурсивная часть:

в ней мы получаем корневые элементы.
Начиная от корневых элементов, рекурсией мы проходимся до листьев дерева,
Одновременно с этим формируется `path` — массив, содержащий путь от корня до текущего элемента. 
Это важно, чтобы не перепутать категории с одинаковыми названиями, но разными родителями:

```postgresql
SELECT c.id,
       c.name,
       c.parent_id,
       ct.level + 1,
       ct.path || c.id
FROM category c
         JOIN "CategoryTree" ct ON c.parent_id = ct.id
```

Мы храним результат данного запроса в `redis`, пока не произойдёт изменение данных. 
При удалении, изменении, добавлении, - кэш очищается. Он появится при следующей
загрузке страницы. 


Ниже приведён список `Makefile` команд. Для запуска нужно находится в корневой папке  
и перед каждой командой прописать `make`. Например, `make up` для запуска compose'а.

| Название команды | Краткое описание                     |
|-----------------:|:-------------------------------------|
|             lint | Проверка isort, black, flake8        |
|             test | запуск тестов                        |
|          migrate | применить миграции из папки versions |
|               up | запустить compose                    |
|             down | остановить compose                   |

## 3. Переменные среды

Переменные среды

| Секрет/перменная среды | Значение по умолчанию | Краткое описание      |
|-----------------------:|:----------------------|-----------------------|
|                DB_HOST | db                    | адрес контейнера с бд |
|                DB_PORT | 5432                  | порт базы данных      |
|            POSTGRES_DB | dbname                | название базы данных  |
|          POSTGRES_USER | username              | пользователь бд       |
|      POSTGRES_PASSWORD | password              | пароль бд             |
|              REDIS_URL | redis://redis:6379/0  | адрес redis           |

## 4. Эндпоинты

- `GET /health` - проверка, не упал ли сервер;
- `GET /` - первая страница с деревом категорий;
- `GET /category/{category_id}` - вторая страница с положением категории в каталоге;
- `POST /add` - добавить категорию;
- `POST /category/{category_id}/update` - обновить имя категории;
- `POST /category/{category_id}/delete` - удалить категорию;

## 5. Диаграммы

Архитектурная схема `/diagrams/architecture.png`  
ER-диаграмма `/diagrams/er.png`
